name: Propagate template updates

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  dispatch:
    runs-on: ubuntu-latest
    if: github.repository == 'energy-modeling-tools/page-template'
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PAGE_TEMPLATE_APP_ID }}
          private_key: ${{ secrets.PAGE_TEMPLATE_APP_PRIVATE_KEY }}
          installation_id: ${{ secrets.PAGE_TEMPLATE_APP_INSTALLATION_ID }}

      - name: Trigger downstream rebuilds
        env:
          TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          if [ -z "${TOKEN:-}" ]; then
            echo "GitHub App token is not available" >&2
            exit 1
          fi

          repos=(
            energy-modeling-tools/energy-modeling-tools.github.io
            energy-modeling-tools/maed2
            energy-modeling-tools/onsset
            energy-modeling-tools/ffrm
            energy-modeling-tools/finplan
            energy-modeling-tools/fintrack
            energy-modeling-tools/minfin
            energy-modeling-tools/nismod
            energy-modeling-tools/pathcalc
            energy-modeling-tools/onstove
            energy-modeling-tools/osemosys
          )

          for repo in "${repos[@]}"; do
            echo "::group::Dispatch to $repo"
            http_code=$(curl -s -o /tmp/resp.txt -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}/dispatches" \
              -d '{"event_type":"page-template-updated"}')

            if [ "$http_code" -ge 300 ]; then
              echo "Failed for $repo (HTTP $http_code):"
              cat /tmp/resp.txt
              exit 1
            fi
            echo "OK for $repo"
            echo "::endgroup::"
          done
