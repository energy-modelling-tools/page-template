name: Propagate template updates

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  dispatch:
    runs-on: ubuntu-latest
    # Accept either org spelling (repository moved)
    if: github.repository == 'energy-modeling-tools/page-template' || github.repository == 'energy-modelling-tools/page-template'
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PAGE_TEMPLATE_APP_ID }}
          private-key: ${{ secrets.PAGE_TEMPLATE_APP_PRIVATE_KEY }}
          owner: energy-modelling-tools

      - name: Trigger downstream rebuilds
        env:
          TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          if [ -z "${TOKEN:-}" ]; then
            echo "GitHub App token is not available" >&2
            exit 1
          fi

          repos=(
            energy-modelling-tools/energy-modelling-tools.github.io
            energy-modelling-tools/maed2
            energy-modelling-tools/onsset
            energy-modelling-tools/ffrm
            energy-modelling-tools/finplan
            energy-modelling-tools/fintrack
            energy-modelling-tools/minfin
            energy-modelling-tools/nismod
            energy-modelling-tools/pathcalc
            energy-modelling-tools/onstove
            energy-modelling-tools/osemosys
            energy-modelling-tools/maed
          )

          for repo in "${repos[@]}"; do
            echo "::group::Dispatch workflow_dispatch to $repo"
            http_code=$(curl -s -o /tmp/resp.txt -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}/actions/workflows/dispatch-rebuild.yml/dispatches" \
              -d '{"ref":"main"}')

            if [ "$http_code" -eq 204 ]; then
              echo "workflow_dispatch OK for $repo"
              echo "::endgroup::"
              continue
            fi

            echo "workflow_dispatch HTTP $http_code, body:"
            cat /tmp/resp.txt

            echo "::group::Fallback repository_dispatch to $repo"
            http_code2=$(curl -s -o /tmp/resp2.txt -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}/dispatches" \
              -d '{"event_type":"page-template-updated"}')

            if [ "$http_code2" -ge 300 ]; then
              echo "Failed for $repo (HTTP $http_code2):"
              cat /tmp/resp2.txt
              exit 1
            fi
            echo "repository_dispatch OK for $repo"
            echo "::endgroup::"
          done
